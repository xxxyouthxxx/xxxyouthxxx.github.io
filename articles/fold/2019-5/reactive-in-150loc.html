<!DOCTYPE html>
<html lang="zh-cmn-Hans">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>🚀 150 行代码带你实现小程序中的数据侦听 | YoochBlog</title>
    <meta name="generator" content="VuePress 1.9.8">
    <link rel="dns-prefetch" href="/utteranc.es">
    <link rel="shortcut icon" href="/favicon.ico">
    <script src="//instant.page/5.1.0" type="module" integrity="sha384-by67kQnR+pyfy8yWP4kPO12fHKRLHZPfEsiSXR8u2IKcTdxD805MGUXBzVPnkLHw" defer="defer"></script>
    <script src="//js.fundebug.cn/fundebug.2.5.0.min.js" crossorigin="anonymous" apikey="6cf8608d1691cea338ccf8b2057530f1991968b20555ea79ff3cb6261e6cba77" defer="defer"></script>
    <script defer="defer">
            var _hmt = _hmt || [];
            (function() {
                var hm = document.createElement("script");
                hm.src = "https://hm.baidu.com/hm.js?9f386eab0658c409277cb8e60691de6e";
                var s = document.getElementsByTagName("script")[0]; 
                s.parentNode.insertBefore(hm, s);
            })();
        </script>
    <script defer="defer" crossorigin="crossorigin">
            window.__bl = {
                config: {
                    pid:"eeh52p97ae@20a026fed78311e",
                    appType:"web",
                    imgUrl:"https://arms-retcode.aliyuncs.com/r.png?",
                    sendResource:true,
                    enableLinkTrace:true,
                    behavior:true,
                    enableConsole:true,
                    useFmp:true
                }
            }
            ;(function() {
                var hm = document.createElement("script");
                hm.src = "https://retcode.alicdn.com/retcode/bl.js";
                var s = document.getElementsByTagName("script")[0]; 
                s.parentNode.insertBefore(hm, s);
            })()
        </script>
    <meta name="description" content="本文介绍了在150行代码内使用defineProperty实现一个简单的拥有事件发布订阅能力的状态管理库的思路。">
    <meta name="keywords" content="JavaScript,defineProperty,响应式,reactive,状态管理,观察者,发布订阅,小程序,小程序刷新页面">
    <meta name="baidu-site-verification" content="Mdz47FJiHx">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <link rel="preload" href="/assets/css/0.styles.68e428c0.css" as="style"><link rel="preload" href="/assets/js/app.dacd158f.js" as="script"><link rel="preload" href="/assets/js/layout-Layout.a690710d.js" as="script"><link rel="preload" href="/assets/js/vendors~layout-Layout.fb1af457.js" as="script"><link rel="preload" href="/assets/js/xingdaimadainishixianxiaochengxuzhongdeshujuzhenting.36b2d444.js" as="script"><link rel="prefetch" href="/assets/js/128.14e69869.js"><link rel="prefetch" href="/assets/js/129.1a612441.js"><link rel="prefetch" href="/assets/js/130.5d292bef.js"><link rel="prefetch" href="/assets/js/131.a2fea7db.js"><link rel="prefetch" href="/assets/js/132.9fac5b08.js"><link rel="prefetch" href="/assets/js/133.c60d2529.js"><link rel="prefetch" href="/assets/js/134.64097e6a.js"><link rel="prefetch" href="/assets/js/135.de69bd66.js"><link rel="prefetch" href="/assets/js/136.a0f1b19f.js"><link rel="prefetch" href="/assets/js/137.4f5ca37a.js"><link rel="prefetch" href="/assets/js/138.65973f98.js"><link rel="prefetch" href="/assets/js/139.f48d9fac.js"><link rel="prefetch" href="/assets/js/140.89d08fb7.js"><link rel="prefetch" href="/assets/js/141.d9c4ac40.js"><link rel="prefetch" href="/assets/js/142.cdf63f1a.js"><link rel="prefetch" href="/assets/js/143.ad8bd569.js"><link rel="prefetch" href="/assets/js/144.c3703271.js"><link rel="prefetch" href="/assets/js/145.df209d87.js"><link rel="prefetch" href="/assets/js/146.9f48b5fb.js"><link rel="prefetch" href="/assets/js/147.9d8e5ea9.js"><link rel="prefetch" href="/assets/js/148.92d33d69.js"><link rel="prefetch" href="/assets/js/149.7334998b.js"><link rel="prefetch" href="/assets/js/150.a39314f5.js"><link rel="prefetch" href="/assets/js/151.3547abfe.js"><link rel="prefetch" href="/assets/js/152.75490790.js"><link rel="prefetch" href="/assets/js/153.32961986.js"><link rel="prefetch" href="/assets/js/154.2b1b2406.js"><link rel="prefetch" href="/assets/js/155.443249cc.js"><link rel="prefetch" href="/assets/js/156.ccdca739.js"><link rel="prefetch" href="/assets/js/157.bc78369c.js"><link rel="prefetch" href="/assets/js/158.fa2a0fea.js"><link rel="prefetch" href="/assets/js/159.f6974d2e.js"><link rel="prefetch" href="/assets/js/160.21aae9c2.js"><link rel="prefetch" href="/assets/js/161.874663ef.js"><link rel="prefetch" href="/assets/js/162.88cbf6a4.js"><link rel="prefetch" href="/assets/js/163.b7f3f94b.js"><link rel="prefetch" href="/assets/js/164.4184e453.js"><link rel="prefetch" href="/assets/js/165.abc9036b.js"><link rel="prefetch" href="/assets/js/166.1b6c63b1.js"><link rel="prefetch" href="/assets/js/167.1afd5ad4.js"><link rel="prefetch" href="/assets/js/168.62ed4043.js"><link rel="prefetch" href="/assets/js/169.d3af4343.js"><link rel="prefetch" href="/assets/js/170.83aa52ec.js"><link rel="prefetch" href="/assets/js/171.c1cdb803.js"><link rel="prefetch" href="/assets/js/172.cca7cc98.js"><link rel="prefetch" href="/assets/js/173.7a963e01.js"><link rel="prefetch" href="/assets/js/174.0fa3de14.js"><link rel="prefetch" href="/assets/js/175.b86d0c48.js"><link rel="prefetch" href="/assets/js/176.de1abb03.js"><link rel="prefetch" href="/assets/js/177.ed588eb6.js"><link rel="prefetch" href="/assets/js/178.6209ff51.js"><link rel="prefetch" href="/assets/js/179.8f890918.js"><link rel="prefetch" href="/assets/js/180.b61430ac.js"><link rel="prefetch" href="/assets/js/181.658647ad.js"><link rel="prefetch" href="/assets/js/182.4877f2ce.js"><link rel="prefetch" href="/assets/js/183.4d29cf19.js"><link rel="prefetch" href="/assets/js/184.61848361.js"><link rel="prefetch" href="/assets/js/185.435db16c.js"><link rel="prefetch" href="/assets/js/186.8dbd1f31.js"><link rel="prefetch" href="/assets/js/187.ce0835f7.js"><link rel="prefetch" href="/assets/js/188.567cb6ab.js"><link rel="prefetch" href="/assets/js/188aa0d0.28c68ff4.js"><link rel="prefetch" href="/assets/js/189.c0489fa4.js"><link rel="prefetch" href="/assets/js/190.87366fac.js"><link rel="prefetch" href="/assets/js/191.334e0179.js"><link rel="prefetch" href="/assets/js/192.b8e03f6a.js"><link rel="prefetch" href="/assets/js/193.55a3491d.js"><link rel="prefetch" href="/assets/js/194.b9b83cb4.js"><link rel="prefetch" href="/assets/js/195.4ffd47b9.js"><link rel="prefetch" href="/assets/js/196.898adb5a.js"><link rel="prefetch" href="/assets/js/197.b2e86c09.js"><link rel="prefetch" href="/assets/js/198.1d8fccd5.js"><link rel="prefetch" href="/assets/js/199.edb243e8.js"><link rel="prefetch" href="/assets/js/200.c1397018.js"><link rel="prefetch" href="/assets/js/201.9fd7f6bb.js"><link rel="prefetch" href="/assets/js/202.ce30cc72.js"><link rel="prefetch" href="/assets/js/202344.7fd5a992.js"><link rel="prefetch" href="/assets/js/203.a6cc52d9.js"><link rel="prefetch" href="/assets/js/204.a1ff59aa.js"><link rel="prefetch" href="/assets/js/205.d21ef5ad.js"><link rel="prefetch" href="/assets/js/206.5c80f5c8.js"><link rel="prefetch" href="/assets/js/207.09f3108c.js"><link rel="prefetch" href="/assets/js/208.00110bb9.js"><link rel="prefetch" href="/assets/js/209.4d289b4b.js"><link rel="prefetch" href="/assets/js/210.fb6cff5d.js"><link rel="prefetch" href="/assets/js/211.74d4174c.js"><link rel="prefetch" href="/assets/js/212.33af8f09.js"><link rel="prefetch" href="/assets/js/213.eda854d9.js"><link rel="prefetch" href="/assets/js/214.ec8e8b02.js"><link rel="prefetch" href="/assets/js/215.9bbf60ca.js"><link rel="prefetch" href="/assets/js/216.13dd6e6a.js"><link rel="prefetch" href="/assets/js/217.cd659ae8.js"><link rel="prefetch" href="/assets/js/218.2090dc69.js"><link rel="prefetch" href="/assets/js/219.816ce836.js"><link rel="prefetch" href="/assets/js/220.e5447b48.js"><link rel="prefetch" href="/assets/js/221.ccacfd12.js"><link rel="prefetch" href="/assets/js/222.49d7c938.js"><link rel="prefetch" href="/assets/js/223.269f23d1.js"><link rel="prefetch" href="/assets/js/224.502262fa.js"><link rel="prefetch" href="/assets/js/225.66e99592.js"><link rel="prefetch" href="/assets/js/226.3e211165.js"><link rel="prefetch" href="/assets/js/227.dc8cdb75.js"><link rel="prefetch" href="/assets/js/228.b66479ab.js"><link rel="prefetch" href="/assets/js/229.8aea98c6.js"><link rel="prefetch" href="/assets/js/230.275f4523.js"><link rel="prefetch" href="/assets/js/231.9c450e06.js"><link rel="prefetch" href="/assets/js/33cd14d0.1870c07a.js"><link rel="prefetch" href="/assets/js/Angular.e5a0840d.js"><link rel="prefetch" href="/assets/js/CSSColorModule.90bbac9c.js"><link rel="prefetch" href="/assets/js/CSSConditionalRulesModule.cfedcaab.js"><link rel="prefetch" href="/assets/js/CSSMindMap.7af0e763.js"><link rel="prefetch" href="/assets/js/CSSScrollbarsStylingModule.ab43f69c.js"><link rel="prefetch" href="/assets/js/CanvasBlocker.28887fdc.js"><link rel="prefetch" href="/assets/js/CloudNative.00c393fd.js"><link rel="prefetch" href="/assets/js/Compiler.5ee42cbd.js"><link rel="prefetch" href="/assets/js/ComputerMindMap.4ba4f5b9.js"><link rel="prefetch" href="/assets/js/DevOpsMindMap.b84593e9.js"><link rel="prefetch" href="/assets/js/Docker.5ff3de47.js"><link rel="prefetch" href="/assets/js/ElementUIElementPlus.369488ba.js"><link rel="prefetch" href="/assets/js/Eviljs.2e1bf83b.js"><link rel="prefetch" href="/assets/js/GitLab.b077a34e.js"><link rel="prefetch" href="/assets/js/GitMindMap.690db46c.js"><link rel="prefetch" href="/assets/js/Gitflow.e370b9eb.js"><link rel="prefetch" href="/assets/js/HTMLExtends.7a0dc665.js"><link rel="prefetch" href="/assets/js/HTMLMindMap.fa563575.js"><link rel="prefetch" href="/assets/js/ITCSSInvertedTriangleCSS.43675008.js"><link rel="prefetch" href="/assets/js/JavaScriptMicroTemplating.c17648de.js"><link rel="prefetch" href="/assets/js/JavaScriptMindMap.91c312e6.js"><link rel="prefetch" href="/assets/js/KingDB.04351f7d.js"><link rel="prefetch" href="/assets/js/Linter.cc80c036.js"><link rel="prefetch" href="/assets/js/Linux.447bbf65.js"><link rel="prefetch" href="/assets/js/Lodashtemplate.c61c4968.js"><link rel="prefetch" href="/assets/js/Monorepo.6593f1de.js"><link rel="prefetch" href="/assets/js/NPM.1df608d2.js"><link rel="prefetch" href="/assets/js/NginxConfigExample.d3990a61.js"><link rel="prefetch" href="/assets/js/NodeJS.9a888fad.js"><link rel="prefetch" href="/assets/js/NodeJSRequire.cc564343.js"><link rel="prefetch" href="/assets/js/Objectassign.2649c0c3.js"><link rel="prefetch" href="/assets/js/PNPMPerformantnpm.6d273ffc.js"><link rel="prefetch" href="/assets/js/Promise.350fd83d.js"><link rel="prefetch" href="/assets/js/ReactMindMap.a2b44c2a.js"><link rel="prefetch" href="/assets/js/ScopedCSS.c481782b.js"><link rel="prefetch" href="/assets/js/SecurityMindMap.51c60576.js"><link rel="prefetch" href="/assets/js/Serverless.da609f3a.js"><link rel="prefetch" href="/assets/js/SubresourceIntegrity.fbedefda.js"><link rel="prefetch" href="/assets/js/TypeScript.7bb165af.js"><link rel="prefetch" href="/assets/js/TypeScriptTypeChanllenges.af95fd05.js"><link rel="prefetch" href="/assets/js/UtilityTypes.8d013e60.js"><link rel="prefetch" href="/assets/js/VersionControl.71d54e96.js"><link rel="prefetch" href="/assets/js/VueJSObserver.13817188.js"><link rel="prefetch" href="/assets/js/VueJSParser.4e5296b8.js"><link rel="prefetch" href="/assets/js/VueMindMap.f8265b4f.js"><link rel="prefetch" href="/assets/js/VueTestUtils.fbc1e853.js"><link rel="prefetch" href="/assets/js/a5d1c9ac.a357a1a4.js"><link rel="prefetch" href="/assets/js/b7d9e848.554e0ecd.js"><link rel="prefetch" href="/assets/js/banmananti.37e5b6ce.js"><link rel="prefetch" href="/assets/js/baoguanliqi.c07e04cc.js"><link rel="prefetch" href="/assets/js/bixujixialai.df65a36c.js"><link rel="prefetch" href="/assets/js/changyongleixingpanduanfangfadeyoushijiquexian.15ea8681.js"><link rel="prefetch" href="/assets/js/chengyunxiaochengxu.9e24e852.js"><link rel="prefetch" href="/assets/js/chengyunxinlingshou.f2313a29.js"><link rel="prefetch" href="/assets/js/congyifufengjinghuazhongxuexigehuituzhishidian.4a97d4c3.js"><link rel="prefetch" href="/assets/js/congyigeyuexieyuemandebianjiqizhongliaoliaoyouhuasilu.9072be75.js"><link rel="prefetch" href="/assets/js/cuowubianjiezujian.d6fd51e9.js"><link rel="prefetch" href="/assets/js/dabaogongju.8fc4bb45.js"><link rel="prefetch" href="/assets/js/deindent.2d2bbafe.js"><link rel="prefetch" href="/assets/js/dibanbenliulanqijianrongbiaoqianyuanli.751b55e7.js"><link rel="prefetch" href="/assets/js/dima.66e54876.js"><link rel="prefetch" href="/assets/js/ganxingqudewenti.a8a342e3.js"><link rel="prefetch" href="/assets/js/gengxinrizhi.2c2c845a.js"><link rel="prefetch" href="/assets/js/gongjuhanshuwuchongtuchuli.e1ff97d4.js"><link rel="prefetch" href="/assets/js/guanyubiaodiandeneixieshier.1c9ba85a.js"><link rel="prefetch" href="/assets/js/guifanjihe.6fb1224b.js"><link rel="prefetch" href="/assets/js/jishujianli.6ae2bacf.js"><link rel="prefetch" href="/assets/js/jisuanjiwangluo.bc344f78.js"><link rel="prefetch" href="/assets/js/jiushixiwangxiangsu.dc79114f.js"><link rel="prefetch" href="/assets/js/kuheyuanma.e67c7103.js"><link rel="prefetch" href="/assets/js/layout-NotFound.af816131.js"><link rel="prefetch" href="/assets/js/leixingticao.795a63d9.js"><link rel="prefetch" href="/assets/js/liaoliaocicilizhibiyejiqitazaluandeshiqing.d60ced8d.js"><link rel="prefetch" href="/assets/js/linghuoyouyawuyilaidepaixuku.ce1a192e.js"><link rel="prefetch" href="/assets/js/liulanqi.53e7507f.js"><link rel="prefetch" href="/assets/js/liulanqixiangguan.c7b80c8f.js"><link rel="prefetch" href="/assets/js/luyoujishu.e9f27357.js"><link rel="prefetch" href="/assets/js/lvmaoshuiguai.0ca6173d.js"><link rel="prefetch" href="/assets/js/mianshifupan.889e1a5f.js"><link rel="prefetch" href="/assets/js/mianshititiku.cba02359.js"><link rel="prefetch" href="/assets/js/mokuaihuajianshi.3e82445c.js"><link rel="prefetch" href="/assets/js/nodewatch.92cf87a8.js"><link rel="prefetch" href="/assets/js/pachongyufanpachong.fe37b781.js"><link rel="prefetch" href="/assets/js/panduanlianggebianliangxiangdeng.cf8dcaf2.js"><link rel="prefetch" href="/assets/js/panduanshifouzaixian.90b5663e.js"><link rel="prefetch" href="/assets/js/qiantaoliebiaobujudexiefa.944bdb10.js"><link rel="prefetch" href="/assets/js/qinmiguanxi.68293a9c.js"><link rel="prefetch" href="/assets/js/quanju.51608a86.js"><link rel="prefetch" href="/assets/js/quanlidouzhengzhongdewudaoyujiashe.55a0af45.js"><link rel="prefetch" href="/assets/js/riji.0586813e.js"><link rel="prefetch" href="/assets/js/shanghupingtai.66fa2c49.js"><link rel="prefetch" href="/assets/js/shenmeshixinliu.747d8593.js"><link rel="prefetch" href="/assets/js/shenmizhuyideyishu.15c0bf08.js"><link rel="prefetch" href="/assets/js/shibasuichumenyuanxing.1af7346b.js"><link rel="prefetch" href="/assets/js/shijiejiushiyigecaotaibanzi.151f897e.js"><link rel="prefetch" href="/assets/js/shujudapan.ff70d86e.js"><link rel="prefetch" href="/assets/js/suanfa.864cbfaa.js"><link rel="prefetch" href="/assets/js/tingshuonihaizaishouxielanjiazai.bf23d4a6.js"><link rel="prefetch" href="/assets/js/webpack.11b618f0.js"><link rel="prefetch" href="/assets/js/weiqianduan.5187ab7b.js"><link rel="prefetch" href="/assets/js/weishimewoyaoxieboke.80ab2a74.js"><link rel="prefetch" href="/assets/js/weishimezhiyouwozhexiayu.d52ab8db.js"><link rel="prefetch" href="/assets/js/wenziyuqingxu.17f9b6cd.js"><link rel="prefetch" href="/assets/js/woxiangyaozaiduyidian.27d70dc0.js"><link rel="prefetch" href="/assets/js/wuti.0270f557.js"><link rel="prefetch" href="/assets/js/xiangmugailan.574da0f9.js"><link rel="prefetch" href="/assets/js/xiangmuguanli.310ad8f1.js"><link rel="prefetch" href="/assets/js/xiaochengxu.f21ad17d.js"><link rel="prefetch" href="/assets/js/xiwangxiangsu.83a5d95f.js"><link rel="prefetch" href="/assets/js/yemianxingneng.2ea2cfa3.js"><link rel="prefetch" href="/assets/js/yifengchenmo.470e2da1.js"><link rel="prefetch" href="/assets/js/yinmi.279fe74e.js"><link rel="prefetch" href="/assets/js/youguanxinxiangmudifangfalun.12cf868d.js"><link rel="prefetch" href="/assets/js/yuanmajiqiao.3291518f.js"><link rel="prefetch" href="/assets/js/yuanmaxuexi.05e2722f.js"><link rel="prefetch" href="/assets/js/yunnazhuanzhengxiaojie.14fb3712.js"><link rel="prefetch" href="/assets/js/yuwolianluoyouqinglianjie.85cfb916.js"><link rel="prefetch" href="/assets/js/zhongtuanjiexi.9d225297.js"><link rel="prefetch" href="/assets/js/zhuixunziyouyumanhuaixiwang.712b2ef9.js"><link rel="prefetch" href="/assets/js/zuijinwoganjue.4e6a7dab.js">
    <link rel="stylesheet" href="/assets/css/0.styles.68e428c0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">YoochBlog</span></a> <div class="links"><!----> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/articles/" class="nav-link router-link-active">
  Posts
</a></div><div class="nav-item"><a href="/friends/" class="nav-link">
  Links
</a></div><div class="nav-item"><a href="/maps/" class="nav-link">
  Maps
</a></div><div class="nav-item"><a href="/hire-me/" class="nav-link">
  HireMe
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/articles/" class="nav-link router-link-active">
  Posts
</a></div><div class="nav-item"><a href="/friends/" class="nav-link">
  Links
</a></div><div class="nav-item"><a href="/maps/" class="nav-link">
  Maps
</a></div><div class="nav-item"><a href="/hire-me/" class="nav-link">
  HireMe
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/journal/" class="sidebar-heading clickable open"><span>傻逼日记 / journal</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/journal/DiaryOfAFool.html" class="sidebar-link">☝️🤓 日记</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/ReadMore/" class="sidebar-heading clickable"><span>再读一点 / ReadMore</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/ReadMore/IntimateRelationship.html" class="sidebar-link">❤️‍🩹亲密关系</a></li><li><a href="/ReadMore/GoingOnALongJourneyAtTheAgeOf18.html" class="sidebar-link">🚶‍♂️‍➡️十八岁出门远行</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/flows/" class="sidebar-heading clickable"><span>心流思绪 / Heart Flows</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/flows/LvMaoShuiGuai.html" class="sidebar-link">🧜‍♀️绿毛水怪</a></li><li><a href="/flows/NowADays.html" class="sidebar-link">🎈最近我感觉......</a></li><li><a href="/flows/WhyOnlyRain.html" class="sidebar-link">👩👨为什么只有我这下雨？</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/maps/" class="sidebar-heading clickable"><span>知识骨架 / Maps</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/maps/business/low-code.html" class="sidebar-link">低码</a></li></ul></section></li><li><a href="/articles/" aria-current="page" class="sidebar-link">技术博客 / Coder</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="🚀-150-行代码带你实现小程序中的数据侦听">🚀 150 行代码带你实现小程序中的数据侦听</h1> <nav class="table-of-contents"><ol><li><a href="#150-行代码带你实现小程序中的数据侦听">🚀 150 行代码带你实现小程序中的数据侦听</a><ol><li><a href="#前言">前言</a></li><li><a href="#稍微理一理思路">稍微理一理思路</a></li><li><a href="#依赖对象的实现">依赖对象的实现</a></li><li><a href="#设置响应式属性">设置响应式属性</a><ol><li><a href="#defineproperty">defineProperty</a></li></ol></li><li><a href="#通过-watch-添加订阅">通过 watch 添加订阅</a><ol><li><a href="#喝口水我们继续">喝口水我们继续</a></li><li><a href="#隐藏-dep">隐藏 Dep</a></li><li><a href="#主动收集依赖">主动收集依赖</a></li></ol></li><li><a href="#处理-key-值为对象链的情况">处理 key 值为对象链的情况</a></li><li><a href="#业务场景应用">业务场景应用</a><ol><li><a href="#小程序跨页面刷新数据">小程序跨页面刷新数据</a></li></ol></li><li><a href="#可能遇到的问题">可能遇到的问题</a><ol><li><a href="#给-watch-方法添加的函数设置立即执行">给 watch 方法添加的函数设置立即执行</a></li><li><a href="#this-绑定丢失问题">this 绑定丢失问题</a></li></ol></li><li><a href="#后语">后语</a></li></ol></li></ol></nav><h2 id="前言">前言</h2> <p>在小程序项目中, 我们的通常会使用到使用到一个全局对象作为各个页面通用的数据存储容器, 将它绑定到 app 对象后, 就能在每一个页面都自由的操纵这个对象. 然而在实践中, 由于这个对象及其属性不具备响应式条件, 它不能直接参与业务逻辑的编写, 能力仅仅局限于数据储存. 若是在 VueJS 项目中, 我们可能经常使用到<code>Vue.$watch</code>去侦听某个数据是否发生变化, 小程序却缺乏这种能力.</p> <p>在这篇文章中, 我将用 150 行代码, 手把手带你打造一个小程序也可以使用的侦听器(下简称 VX):</p> <div class="language-JS extra-class"><pre class="language-js"><code><span class="token comment">// 一个快速赋值的语法糖函数, 可以创建结构为 { value: a { b: { val: ''} } } 的对象</span>
vx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'value.a.d'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">val</span><span class="token operator">:</span> <span class="token string">''</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 对某个属性进行侦听, 如果发生改变, 则执行相应函数(可多次watch以执行多个函数)</span>
vx<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'value.a.d.val'</span><span class="token punctuation">,</span> <span class="token parameter">newVal</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">val改变为 : </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> newVal<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
value<span class="token punctuation">.</span>a<span class="token punctuation">.</span>d<span class="token punctuation">.</span>val <span class="token operator">=</span> <span class="token number">3</span> <span class="token comment">// val改编为 : 3</span>
</code></pre></div><p>使用 VX 侦听器, 我们可以更加方便的管理各个页面的状态. 同时, 我们凭借<code>watch</code>语法, 可以更优雅地编写业务逻辑.</p> <p>坐稳了, 三轮车准备启动了~ 各位评论见~ 😋</p> <h2 id="稍微理一理思路">稍微理一理思路</h2> <p>在全局对象中, 我们不一定要对每一个属性都进行侦听, 所以 VX 主要的功能就是通过 set 去设置某个具体属性的 setter/getter, 同时通过 watch 向添加该属性添加需要订阅的回调函数.</p> <h2 id="依赖对象的实现">依赖对象的实现</h2> <p>首先我们需要造一个通用的<strong>依赖对象</strong>, 依赖对象携带一个订阅数组用于存放一组回调函数, 同时它还应该包括一些操作订阅数组能力(如添加订阅, 清空订阅)的函数</p> <div class="language-JS extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Dep</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 将回调添加到数组中</span>
  <span class="token function">addSub</span> <span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/*...*/</span> <span class="token punctuation">}</span>
  <span class="token function">delSub</span> <span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/*...*/</span> <span class="token punctuation">}</span>
  <span class="token comment">// 执行数组中每一项函数</span>
  <span class="token function">notify</span> <span class="token punctuation">(</span><span class="token parameter">newVal<span class="token punctuation">,</span> oldVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">func</span> <span class="token operator">=&gt;</span> <span class="token function">func</span><span class="token punctuation">(</span>newVal<span class="token punctuation">,</span> oldVal<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>全局对象中每一个响应式属性(及其每一个子属性), 都应该和一个新的 Dep 实例保持一一对应的关系, 这样我们进行侦听变化, 执行订阅的回调函数时, 只需要找到对应的实例执行<code>notify</code>通知更新即可.</p> <h2 id="设置响应式属性">设置响应式属性</h2> <h3 id="defineproperty">defineProperty</h3> <p>可能是因为接触 DefineProperty 要比接触 Proxy 早一些的缘故, 代码使用了前者进行响应式的实现, Object.defineProperty 方法会直接在一个对象上定义一个新属性, 这里快速过一遍<code>defineProperty</code>具体配置:</p> <div class="language-JS extra-class"><pre class="language-js"><code><span class="token comment">// @param obj 要在其上定义属性的对象</span>
<span class="token comment">// @param key 要定义或修改的属性的名称</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// 该属性是否能被枚举</span>
  <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token comment">// 该属性能否被删除</span>
  <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token comment">// 访问该属性则会执行此方法</span>
  <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> val
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 修改该属性时会执行此方法</span>
  <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token parameter">newVal</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    val <span class="token operator">=</span> newVal
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// value &amp; writeble 不能和 getter/setter 同时出现</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>通过对 defineProperty 进行上层封装, 我们可以轻松的实现在全局对象上设置响应式属性功能, 在此, 我们结合刚才定义的 Dep 对象, 将一个新的 dep 实例绑定到新增属性的 setter 中:</p> <div class="language-JS extra-class"><pre class="language-js"><code><span class="token function">set</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> val<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> obj <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>store<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> val
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token parameter">newVal</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>newVal <span class="token operator">===</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
      dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span>newVal<span class="token punctuation">,</span> val<span class="token punctuation">)</span>
      val <span class="token operator">=</span> newVal
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>每当对应属性被赋值, 就会执行依赖数组中的回调函数.</p> <p>不过这样还不够, 我们还得想办法获取到这个 dep 实例, 才能给它的依赖数组填充函数.</p> <p>这边提供一个很简单的思路, 并不推荐实践中这么做:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">set</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> val<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> obj <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>store<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> dep
<span class="token punctuation">}</span>
</code></pre></div><div class="language-JS extra-class"><pre class="language-js"><code><span class="token keyword">const</span> valueDep <span class="token operator">=</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'value'</span><span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
valueDep<span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'value changed!'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>虽然代码能使用了, 就是是看起来怪怪的~ 😋 我们的三轮车开进了岔路~</p> <h2 id="通过-watch-添加订阅">通过 watch 添加订阅</h2> <h3 id="喝口水我们继续">喝口水我们继续</h3> <p>《黑客与画家》中曾经提到这样一个观点, 我深有体会:</p> <blockquote><p>如果你觉得你的代码奇怪, 那么往往它是错的</p></blockquote> <p>上面的那一串代码仅仅是能跑通的水平, 我们需要加入更多的细节和思考, 有时候只需要坐下来稍微看一下代码, 就会有各种想法蹦出来:</p> <blockquote><p>构思这种东西有一个特点，那就是它会导致更多的构思。你有没有注意过，坐下来写东西的时候，一半的构思是写作时产生的？</p></blockquote> <h3 id="隐藏-dep">隐藏 Dep</h3> <p>这些内容应和外部是解耦的. 首先一点, 我们创建一个侦听器类, 用于封装我们侦听所用到的所有方法, 它包含了我们想要的全局对象以及操作它的方法(如 watch,set):</p> <div class="language-JS extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">VX</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>store <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">watch</span> <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> obj <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>store</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">set</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> val<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> obj <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>store<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> vx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VX</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>我们可以在 watch 中给对象某个属性添加回调, 就不用去直接操作 Dep 依赖数组了. 只是, 我们在业务代码中调用 watch, 要怎么去获取 obj.key 对应的 dep 呢?</p> <p>我们设置一个全局的 depHandler, 在 obj.key 的 getter 中主动将 depHandler 设置为当前 obj.key 的 dep 实例, 那么我们在 watch 函数里, 只要用任意操作触发 obj.key 的 getter, 就能通过 depHandler 得到它的 dep 实例了, 代码形如:</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// 一开始没有持有dep实例</span>
  <span class="token keyword">let</span> handleDep <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token keyword">class</span> <span class="token class-name">VX</span> <span class="token punctuation">{</span>
    <span class="token function">watch</span> <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> obj <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>store</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token comment">// 使用任意操作触发obj.key的getter, 那么handleDep将自动引用obj.key的dep实例</span>
      handleDep<span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">set</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> val<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> obj <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>store<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          handleDep <span class="token operator">=</span> dep
          <span class="token keyword">return</span> val
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token parameter">newVal</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="主动收集依赖">主动收集依赖</h3> <p>我们增加<code>handleDep.addSub(fn)</code>添加回调函数的逻辑, 其实可以直接放到 getter 中, 首先在 Dep 类中封装一个'主动'收集依赖的<code>collect</code>方法, 他会将全局<code>handleFn</code>存放到订阅数组中, 这样一来, 在 watch 函数中, 我们只要触发 obj.key 的 getter, 就可以主动收集依赖了:</p> <div class="language-JS extra-class"><pre class="language-js"><code><span class="token keyword">let</span> handleFn <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token keyword">class</span> <span class="token class-name">Dep</span> <span class="token punctuation">{</span>
  <span class="token function">addSub</span> <span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">delSub</span> <span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">clear</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">collect</span> <span class="token punctuation">(</span><span class="token parameter">fn <span class="token operator">=</span> handleFn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fn <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">x</span> <span class="token operator">=&gt;</span> x <span class="token operator">===</span> fn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">notify</span> <span class="token punctuation">(</span><span class="token parameter">newVal<span class="token punctuation">,</span> oldVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> handleDep <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token keyword">class</span> <span class="token class-name">VX</span> <span class="token punctuation">{</span>
  <span class="token function">watch</span> <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> obj <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>store</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    handleFn <span class="token operator">=</span> fn
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">set</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> val<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> obj <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>store<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        handleDep <span class="token operator">=</span> dep
        handleDep<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> val
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token parameter">newVal</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="处理-key-值为对象链的情况">处理 key 值为对象链的情况</h2> <p>在先前的 watch 函数中, 我们使用 console.log(obj.key)去触发对应属性的 getter, 如果我们调用方式是<code>watch('a.b.c')</code>就无能为力了. 这里我们封装一个通用方法, 用于处理对象链字符串的形式:</p> <div class="language-JS extra-class"><pre class="language-js"><code><span class="token comment">// 通过将字符串'a.b'分割为['a', 'b'], 再使用一个while循环就可以走完这个对象链</span>
<span class="token keyword">function</span> <span class="token function">walkChains</span> <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> segments <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> deepObj <span class="token operator">=</span> obj
  <span class="token keyword">while</span> <span class="token punctuation">(</span>segments<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    deepObj <span class="token operator">=</span> deepObj<span class="token punctuation">[</span>segments<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">VX</span> <span class="token punctuation">{</span>
  <span class="token function">watch</span> <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> obj <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>store</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    handleFn <span class="token operator">=</span> fn
    <span class="token function">walkChains</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> obj<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在 set 方法中处理对象链字符串稍微有些不同, 因为如果<code>set('a.b')</code>时, 没有在我们全局对象中找到 a 属性, 这里应该抛错.</p> <p>实际的处理中, 需要推断'obj.a'以及'obj.a.b'是否存在. 假设没有'obj.a', 那么我们应该创建一个新的对象, 并且给新的对象添加属性'b', 所以代码类似<code>walkChains</code>函数, 只是稍作一层判断:</p> <div class="language-JS extra-class"><pre class="language-js"><code><span class="token function">set</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> val<span class="token punctuation">,</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> segments <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span>
  <span class="token comment">// 这里需要注意, 我们只处理到倒数第二个属性</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>segments<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> handleKey <span class="token operator">=</span> segments<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> handleVal <span class="token operator">=</span> obj<span class="token punctuation">[</span>handleKey<span class="token punctuation">]</span>
    <span class="token comment">// 存在'obj.a'的情况</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> handleVal <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      obj <span class="token operator">=</span> handleVal
    <span class="token comment">// 不存在'obj.a'则给a属性赋一个非响应式的对象</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>handleVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      obj <span class="token operator">=</span> <span class="token punctuation">(</span>
        key <span class="token operator">=</span> handleKey<span class="token punctuation">,</span>
        obj<span class="token punctuation">[</span>handleKey<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        obj<span class="token punctuation">[</span>handleKey<span class="token punctuation">]</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">'already has val'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 最后一个属性要手动赋值</span>
  key <span class="token operator">=</span> segments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="业务场景应用">业务场景应用</h2> <h3 id="小程序跨页面刷新数据">小程序跨页面刷新数据</h3> <p>我们经常碰到在小程序中由 A 页面跳转到 B 页面, 如果 B 页面进行了一些操作, 希望 A 页面自动刷新数据的情况. 但是由于 A 页面跳转到 B 页面不同(也许是 redirect,也许是 navigate), 处理方法也不尽相同.</p> <p>使用 navigate 方式跳转后, A 页面不会被注销, 所以我们一般会通过全局对象去贮存 A 页面实例(也就是 A 页面的 this 对象), 然后在 B 页面直接调用相应的方法(如 A.refreshList())进行刷新操作.</p> <p>引入 VX 后, 我们可以在<code>onload</code>生命周期直接调用 watch 方法添加订阅:</p> <div class="language-JS extra-class"><pre class="language-js"><code><span class="token comment">// app.js</span>
<span class="token keyword">import</span> <span class="token constant">VX</span> <span class="token keyword">from</span> <span class="token string">'@/utils/suites/vx'</span>
<span class="token keyword">const</span> vx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VX</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span>vx <span class="token operator">=</span> vx
app<span class="token punctuation">.</span>store <span class="token operator">=</span> vx<span class="token punctuation">.</span>store
app<span class="token punctuation">.</span>vx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'userType'</span><span class="token punctuation">,</span> <span class="token string">'商户'</span><span class="token punctuation">)</span>

<span class="token comment">// page a</span>
<span class="token function">onLoad</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span>vx<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'userType'</span><span class="token punctuation">,</span> <span class="token parameter">userType</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>userType <span class="token operator">===</span> <span class="token string">'商户'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>userType <span class="token operator">===</span> <span class="token string">'管理员'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">immediate</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// page b</span>
<span class="token function">switchUserType</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span>store<span class="token punctuation">.</span>userType <span class="token operator">=</span> <span class="token string">'管理员'</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="可能遇到的问题">可能遇到的问题</h2> <h3 id="给-watch-方法添加的函数设置立即执行">给 watch 方法添加的函数设置立即执行</h3> <p>有的时候我们希望通过 watch 添加函数的同时还立即执行该函数一次, 这个时候我们需要再定义额外的参数传递到 watch 中. 问题是这个函数不一定是同步函数.</p> <p>简单处理如下:</p> <div class="language-JS extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">VX</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">watch</span> <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">immediately</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> obj <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>store</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    handleDep <span class="token operator">=</span> fn
    <span class="token function">walkChains</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> obj<span class="token punctuation">)</span>
    options<span class="token punctuation">.</span>immediately <span class="token operator">&amp;&amp;</span> <span class="token keyword">await</span> <span class="token function">fn</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>defaultParams<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="this-绑定丢失问题">this 绑定丢失问题</h3> <p>在我在对 VX 进行删除属性方法的扩展时, 我往 walkChain 函数中添加了一个执行回调函数的机制, 并且在删除属性这个方法直接调用了 walkChain:</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">walkChains</span> <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> segments <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> deepObj <span class="token operator">=</span> obj
    <span class="token keyword">while</span> <span class="token punctuation">(</span>segments<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      deepObj <span class="token operator">=</span> deepObj<span class="token punctuation">[</span>segments<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
      fn <span class="token operator">&amp;&amp;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><div class="language-JS extra-class"><pre class="language-js"><code><span class="token function">del</span> <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> obj <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>store</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">walkChains</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> handleDep<span class="token punctuation">.</span>clear<span class="token punctuation">)</span>
  <span class="token keyword">delete</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>因为 handleDep.clear 当成参数传递进 walkChains 中会<strong>丢失 this 绑定</strong>, 所以上面那段代码其实是有问题的, 不过稍作修改就好了:</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">del</span> <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> obj <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>store</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">walkChains</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> handleDep<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">delete</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
</code></pre></div><h2 id="后语">后语</h2> <p>在这篇文章中, 我们通过对 defineProperty 进行封装, 实现了一个简单的对象属性侦听器的功能, 以弥补小程序所没有的$watch 能力. 在此基础上, 各位可以再对 VX 进行扩展, 更方便地去书写业务代码.</p> <p>完整代码 <a href="https://github.com/Lionad-Morotar/media-gear/blob/master/src/renderer/utils/suites/vx/index.js" target="_blank" rel="noopener noreferrer">GitHub 直达</a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">本文最后更新于:</span> <span class="time">February 24 2023 11:00</span></div></footer> <!----> <div id="page-bottom" data-v-6ec234cc></div></main></div><div class="global-ui"><Comment></Comment></div></div>
    <script src="/assets/js/app.dacd158f.js" defer></script><script src="/assets/js/layout-Layout.a690710d.js" defer></script><script src="/assets/js/vendors~layout-Layout.fb1af457.js" defer></script><script src="/assets/js/xingdaimadainishixianxiaochengxuzhongdeshujuzhenting.36b2d444.js" defer></script>
  </body>
</html>
